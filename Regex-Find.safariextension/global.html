<script>

// State information
var index = 1;
var positions = [];

safari.application.addEventListener("command", performCommand, false);

function performCommand(event) {
    if (event.command == "regex-find") {
        safari.application.activeBrowserWindow.activeTab.page.dispatchMessage("search", null);
    }
}

// Listens to message from injected keyboardShortcutHandler.js
safari.application.addEventListener('message', handleKeyboardMessage, false);

// Message gets caught, methods of search.js get called
function handleKeyboardMessage(e) {
    if (e.name == 'search') {
        safari.application.activeBrowserWindow.activeTab.page.dispatchMessage("search", null);
    }
    if (e.name == 'next') {
        next = positions[index];
        index++;
        if (index == positions.length) {
            index = 0;
        }
        safari.application.activeBrowserWindow.activeTab.page.dispatchMessage("next", next);
    }
    if (e.name == 'set-state') {
        positions = e.message;
        index = 1;
    }

}

</script>
